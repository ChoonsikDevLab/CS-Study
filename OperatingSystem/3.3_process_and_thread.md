# 3.3 프로세스와 스레드

프로세스(process)
컴퓨터에서 실행되고 있는 프로그램을 말하며 CPU 스케줄링의 대상이 되는 작업

스레드(thread)
프로세스 내 작업의 흐름을 지칭

## 프로세스와 컴파일 과정
**프로세스**는 프로그램이 메모리에 올라가 인스턴스화된 것을 말한다.


컴파일 과정
- 전처리

- 컴파일러

- 어셈블러

- 링커


## 프로세스의 상태
![image](https://velog.velcdn.com/images/narangke3/post/9adc7c35-2e7c-46fb-8875-60213259a597/image.png)
준비, 실행, 대기 간 상태 전이: CPU 스케줄링 알고리즘에 의해 수행된다.

- 생성 상태(new) <br>
    프로세스가 생성된 상태를 의미한다.
    fork() 또는 exec() 함수를 통해 생성한다.
    이때 PCB가 할당된다.

- 준비 상태(ready) <br>
    CPU를 할당받기를 기다리는 상태이다.
    CPU를 할당 받으면 실행 상태가 된다.

- 실행 상태(running) <br>
    CPU를 할당받아 실행 중인 상태로, 일정 시간 동안만 CPU를 사용할 수 있다. <br>
    타이머 인터럽트가 발생하여 프로세스가 할당된 시간을 모두 사용하면 다시 준비 상태가 되고, 실행 도중 입출력장치를 사용하여 입출력장치의 작업이 끝날 때까지 기다려야 하면 대기 상태가 된다.

- 대기 상태(blocked)
    프로세스가 입출력 작업을 요청하거나 바로 확보할 수 없는 자원을 요청하는 등 곧장 실행이 불가능한 조건에 놓이는 경우 대기 상태가 된다.
    대기 상태였던 프로세스는 실행 가능한 상태가 되면 다시 준비 상태가 되어 CPU 할당을 기다린다.

- 종료 상태(terminated) <br>
    프로세스가 종료된 상태를 말한다. 운영체제는 PCB와 프로세스가 사용한 메모리를 정리한다.

## 프로세스의 메모리 구조

![image](https://blog.kakaocdn.net/dn/lKO90/btsES2rvS7a/fSkKomTeo1ZJepCJDnFl61/img.png)

위에서부터 스택, 힙, 데이터 영역(BSS segment, Data segment), 코드 영역(code segment/text segment)으로 나뉜다.

- 스택과 힙 | 동적 할당 영역<br>
    - 스택 영역(stack segment)
        - 지역 변수, 매개 변수, 실행되는 함수에 의해 늘어들거나 줄어드는 메모리 영역이다.
        - 함수가 호출될 때마다 호출될 때의 환경 등 특정 정보가 스택에 계속해서 저장된다.
        - 일시적으로 사용되는 값들이 저장되는 공간이다.
        - 더 자세히는 함수의 실행이 끝나면 사라지는 매개변수, 지역 변수, 함수 복귀 주소 등이 스택 영역에 저장된다.
        - 또한 스택 영역에는 스택 트레이스 형태의 함수 호출 정보가 저장될 수 있다.

    - 힙 영역(heap segment) <br> 
        - 동적으로 할당되는 변수들을 담는다.
        - 프로그램을 만드는 사용자가 직접 할당 가능한 저장 공간이다.
        - 프로그램 실행 도중 할당 가능한 메모리 공간이며, 사용 후 반환해야 한다.
        - 메모리 공간을 반환하지 않을 경우, 메모리 누수 문제를 초래할 수 있다. (Java의 해결 방안: GC)

- 데이터 영역과 코드 영역 | 정적 할당 영역<br>
    - BSS 영역(BSS segment) <br>
    데이터 영역과 동일하나 초깃값이 없는 데이터가 BSS 영역에 저장된다.

    - 데이터 영역(Data segment) <br>
    프로그램이 실행되는 동안 유지할 데이터가 저장되는 공간으로, 정적 변수나 전역 변수가 저장된다.

    - 코드 영역(code segment) <br>
    CPU가 읽고 실행할 명령어가 담겨 있어 쓰기가 금지되어 있는 읽기 전용 공간이다.

## PCB(Process Control Block)
프로세스에 대한 메타데이터를 저장한 '데이터'를 말한다.
메모리에 적재된 다수의 프로세스를 관리하기 위해 프로세스를 식별할 수 있는 정보를 저장한다.

PCB는 프로세스의 중요한 정보를 포함하고 있기 때문에 프로세스가 생성됐을 때 커널 영역에 만들어지고, 프로세스의 실행이 끝나면 폐기된다.


### PCB의 구조
- 프로세스 스케줄링 상태
- 프로세스 ID
- 프로세스 권한
- 프로그램 카운터
- CPU 레지스터
- CPU 스케줄링 정보
- 계정 정보
- I/O 상태 정보

### 컨텍스트 스위칭

> context: 프로세스 수행을 재개하기 위해 기억해야 할 정보

컨텍스트 스위칭이란 PCB를 기반으로 프로세스의 상태를 저장하고 로드시키는 과정을 말한다.
한 프로세스에 할당된 시간이 끝나거나 인터럽트에 의해 발생한다.

*참고: 아래 이미지는 싱글 코어 기준 설명이다. <br>
![image](https://blog.kakaocdn.net/dn/c3wWnK/btq2NcrH2wm/YikhwPpGK6p8Yu72QmDxi1/img.jpg)

> 인터럽트 발생 ➡️ 해당 프로세스의 PCB에 문맥을 백업 ➡️ 이어서 실행할 프로세스의 문맥 복구

잦은 문맥 교환은 캐시 미스 발생 가능성을 높여 메모리로부터 실행할 프로세스 내용을 가져오는 일이 빈번해진다.
이는 큰 오버헤드로 이어질 수 있다.

컨텍스트 스위칭은 스레드에서도 일어난다.
스레드는 스택 영역을 제외한 모든 메모리를 공유하기 때문에 스레드 컨텍스트 스위칭의 경우 비용이 더 적고 시간도 더 적게 걸린다.

## 멀티프로세싱
여러 개의 프로세스를 통해 동시에 두 가지 이상의 일을 수행할 수 있는 것을 말한다.

### 웹 브라우저
웹 브라우저는 멀티 프로세스 구조를 가지고 있다.
![image](https://blog.kakaocdn.net/dn/wWoCW/btsFEwc4phY/4NTs84S5JjKTxEtJ1hDWb0/img.png)

### IPC(Inter Process Communication)
멀티프로세스는 프로세스 간 통신(IPC, Inter Process Communication)이 가능하다.
프로세스 간 통신 방식으로 `공유 메모리`와 `메시지 전달` 방식이 있다.

- 공유 메모리 <br>
    ![image](https://hackyboiz.github.io/2021/11/05/poosic/shared-memory/image1.png)
    
    여러 프로세스에 동일한 메모리 블록에 대한 접근 권한이 부여되어 프로세스가 서로 통신할 수 있도록 공유 메모리를 생성해서 통신하는 것
    각 프로세스 메모리 공간 외에 공유 메모리 공간을 할당하여 데이터를 공유하는 방법이다. <br>
    데이터가 커널 영역을 거치지 않아 통신 속도가 빠르다. 하지만 데이터 일관성이 훼손될 우려가 있다.

- 메시지 전달 <br>
    프로세스간 주고받을 데이터가 커널을 거쳐 송수신되는 통신 방식이다. <br>
    커널의 도움을 받을 수 있으므로 레이스 컨디션, 동기화 등의 문제를 고려하는 일이 적다. 하지만 데이터가 커널을 통해 송수신되므로 통신 속도가 느리다. <br>
    메시지 전달을 위한 수단으로는 파이프, 시그널, 소켓, 원격 프로시저 호출(RPC) 등이 있다.

    - 소켓 <br>
        동일한 컴퓨터의 다른 프로세스나 네트워크의 다른 컴퓨터로 네트워크 인터페이스를 통해 전송하는 데이터를 의미한다.
        TCP와 UDP가 있다.

    - 익명 파이프(unnamed pipe) <br>
        프로세스 간에 FIFO 방식으로 읽히는 임시 공간인 파이프를 기반으로 데이터를 주고 받으며, 단방향 방식의 일기 전용, 쓰기 전용 파이프를 만들어서 작동하는 방식을 말한다. <br>
        부모, 자식 프로세스 간에만 사용할 수 있으며 다른 네트워크상에서는 사용이 불가능하다.

    - 지명 파이프(named pipe) <br>
        파이프 서버와 하나 이상의 파이프 클라이언트 간의 통신을 위한 명명된 단방향 또는 양방향 파이프를 말한다.
        컴퓨터의 프로세스끼리 또는 다른 네트워크상의 컴퓨터와도 통신을 할 수 있다.

    - 메시지 큐 <br>
        메시지를 큐(queue) 데이터 구조 형태로 관리하는 것을 의미한다.

## 스레드와 멀티스레딩

### 스레드
프로세스의 실행 가능한 가장 작은 단위이다. <br>
프로세스는 여러 스레드를 가질 수 있다. <br>
스레드는 코드, 데이터, 힙은 스레드끼리 서로 공유한다.

### 멀티스레딩
프로세스 내 작업을 여러 개의 스레드, 멀티스레드로 처리하는 기법이다. <br>
스레드끼리 서로 자원을 공유하기 때문에 효율성이 높다. <br>
한 스레드에 문제가 생기면 다른 스레드에도 영향을 끼쳐 프로세스에 영향을 줄 수 있다.

## 공유 자원과 임계 영역

### 공유 자원
시스템 안에서 각 프로세스, 스레드가 함께 접근할 수 있는 자원이나 변수 등을 의미한다. <br>
이 공유 자원을 두 개 이상의 프로세스가 동시에 읽거나 쓰는 상황을 경쟁 상태(race condition)라고 한다.

### 임계 영역
임계 영역은 둘 이상의 프로세스, 스레드가 공유 자원에 접근할 때 순서 등의 이유로 결과가 달라지는 코드 영역을 말한다. <br>
임계 영역을 해결하기 위한 방법은 뮤텍스, 세마포어, 모니터 세 가지가 있으며, 이 방법 모두 상호 배제, 한정 대기, 융통성이란 조건을 만족한다.

- 뮤텍스(mutex) <br>
    프로세스나 스레드가 공유 자원을 lock()을 통해 잠금 설정하고 사용한 후에는 unlock()을 통해 잠금 해제하는 객체이다. <br>
    잠금 또는 잠금 해제 상태만을 가진다.
    ![image](https://velog.velcdn.com/images/octo__/post/e268ce48-d4ce-4e35-8c25-d188c5718fa1/image.png)

- 세마포어(semaphore) <br>
    일반화된 뮤텍스이다.
    간단한 정수 값과 두 가지 함수 wait() 및 signal()로 공유 자원에 대한 접근을 처리한다. <br>
    공유 자원이 여러 개 있는 상황에서도 동기화가 가능하다.
    ![image](https://blog.kakaocdn.net/dn/cYZOiu/btrjvrzaimS/QtooHYav5Sj1JpT9yTtb1K/img.png)

- 모니터(monitor) <br>
    둘 이상의 스레드나 프로세스가 공유 자원에 안전하게 접근할 수 있도록 공유 자원을 숨기고 해당 접근에 대해 인터페이스만 제공한다.

## 교착 상태(deadlock)
두 개 이상의 프로세스들이 서로가 가진 자원을 기다리며 중단된 상태를 말한다.

### 교착 상태의 원인
- 상호 배제: 한 프로세스가 자원을 독점하고 있으며 다른 프로세스들은 접근이 불가능하다.
- 점유 대기: 특정 프로세스가 점유한 자원을 다른 프로세스가 요청하는 상태이다.
- 비선점: 다른 프로세스의 자원을 강제적으로 가져올 수 없다.
- 환형 대기: 프로세스 A는 프로세스 B의 자원을 요구하고, 프로세스 B는 프로세스 A의 자원을 요구하는 등 서로가 서로의 자원을 요구하는 상황을 말한다.

### 교착 상태의 해결 방법
1. 자원을 할당할 때 애초에 조건이 성립되지 않도록 설계합니다.
2. 교착 상태 가능성이 없을 때만 자원 할당되며, 프로세스 당 요청할 자원의 최대치를 통해 자원 할당 가능 여부를 파악하는 '은행원 알고리즘'을 씁니다.
3. 교착 상태가 발생하면 사이클이 있는지 찾아보고 이에 관련된 프로세스를 한 개씩 지웁니다.
4. 교착 상태는 매우 드물게 일어나기 때문에 이를 처리하는 비용이 더 커서 교착 상태가 발생하면 사용자가 작업을 종료합니다.

---
# 예상 질문
<details>
<summary> 
1. PCB는 무엇인가요?
</summary>

    프로세스에 대한 메타데이터를 저장한 데이터를 말합니다. 
    
    프로세스가 생성되면 운영체제는 PCB를 생성해 메타 데이터를 저장하고 관리합니다.
    이는 프로세스의 중요한 정보를 포함하고 있기 때문에 일반 사용자가 접근하지 못하도록 커널 스택의 가장 앞부분에서 관리됩니다.
</details>

<br>

<details>
<summary> 
2. 프로세스와 스레드의 차이에 대해 설명해주세요.
</summary>

    프로세스는 실행중인 프로그램을 의미합니다. 스레드는 실행 제어만 분리한 것을 의미합니다.

    프로세스는 운영체제로부터 자원을 할당받지만, 스레드는 프로세스로부터 자원을 할당받고, 프로세스의 코드/데이터/힙영역을 공유하기 때문에 좀 더 효율적으로 통신할 수 있습니다. 또한 컨텍스트 스위칭도 캐시 메모리를 비우지 않아도 되는 스레드쪽이 빠릅니다. 그리고, 스레드는 자원 공유로 인해 문제가 발생할 수 있으니 이를 염두에 둔 프로그래밍을 해야합니다.

    한 프로세스 안에 여러개의 스레드가 생성될 수 있습니다.
</details>

<br>

<details>
<summary> 
3. 멀티 프로세스와 멀티 스레드의 차이는 무엇인가요? 둘을 비교하여 설명해주세요.
</summary>

    멀티 프로세스 (Multi-Process)
    - 여러 개의 독립적인 프로세스를 생성하여 각 프로세스가 별도의 메모리 공간에서 병렬로 실행됩니다.
    - 프로세스 간 메모리가 분리되어 있어, 하나의 프로세스가 오류를 일으켜도 다른 프로세스에 영향을 주지 않습니다.
    - 프로세스 간 문맥 전환 비용이 높습니다(프로세스 컨텍스트 스위칭).

    멀티 스레드 (Multi-Thread)
    - 하나의 프로세스 내에서 여러 스레드가 생성되어 공유된 메모리 공간에서 병렬로 실행됩니다.
    - 공유된 메모리 공간을 사용하기 때문에 하나의 스레드가 오류를 일으키면 전체 프로세스에 영향을 미칠 수 있습니다.
    - 스레드는 프로세스에 비해 더 빠르게 생성되고 문맥 전환도 가볍습니다.
</details>

<br>

<details>
<summary> 
4. Thread-safe 하다는 의미는 무엇인가요? 이를 설계하는 방법에 대해서도 설명해주세요.
</summary>

    Thread-safe 하다는 것은 멀티스레드 환경에서 어떤 변수나 함수, 객체 등이 동시에 여러 스레드에 의해 접근되더라도 정상적으로 동작하는 상태를 의미합니다.
    Thread-safe하지 않은 코드는 레이스 컨디션(race condition) 문제가 발생할 수 있습니다. 

    이러한 문제를 방지하기 위해, 임계 구역(critical section)에 동기화 기법을 적용할 수 있습니다.
    - 뮤텍스 락
        하나의 스레드만 락을 획득하여 자원에 접근할 수 있으며, 락을 획득한 스레드가 임계 구역을 벗어날 때 락을 해제해야 합니다.
    - 세마포어
        세마포어는 일정한 카운터 값을 기반으로 한 동기화 기법입니다.

    가능하다면 불변 객체를 사용하여 상태 변화를 방지하는 방법도 있습니다.
</details>

<br>

<details>
<summary> 
5. 동기와 비동기의 장단점 및 차이점에 대해서 비교하며 설명해주세요.
</summary>

    동기(Synchronous)
    : 작업을 요청한 후, 요청한 작업이 완료될 때까지 요청한 주체(예: 프로세스, 스레드)가 대기하는 방식입니다.
    
    장점
    - 제어 흐름이 직관적이며, 코드 작성과 디버깅이 상대적으로 쉽습니다.
    - 작업이 순차적으로 진행되므로, 작업 완료 시점을 예측하기 쉽습니다.
    
    단점
    - 요청한 주체가 작업 완료를 대기하면서 자원을 비효율적으로 사용하게 됩니다.
    - 하나의 작업이 완료될 때까지 다음 작업을 진행할 수 없으므로, 전체 응답 시간이 느려질 수 있습니다.

    비동기(Asynchronous)
    : 작업을 요청한 후, 요청한 작업이 완료되기 전에 제어권이 즉시 반환되며, 작업이 백그라운드에서 진행됩니다. 완료되면 콜백 또는 이벤트로 결과를 처리합니다.

    장점
    - 요청 주체가 작업을 대기하지 않고 다른 작업을 처리할 수 있어 자원 활용도가 높습니다.
    - 대기 시간이 없으므로 시스템의 응답 속도가 개선될 수 있습니다.
    
    단점:
    - 제어 흐름이 복잡해지고, 코드 작성과 디버깅이 어려울 수 있습니다.
    - 비동기 코드의 실행 순서가 예측하기 어려워, 문제 발생 시 원인을 추적하기 어렵습니다.
</details>

<br>

---

# 참고 자료

예상 질문 및 답변
- [Backend-Interview-Question](https://github.com/ksundong/backend-interview-question?tab=readme-ov-file#CS-%EA%B4%80%EB%A0%A8-%EC%A7%80%EC%8B%9D)
- [tech_interview.zip](https://github.com/4z7l/tech_interview.zip)

참고 도서
- [면접을 위한 CS 전공지식 노트](https://product.kyobobook.co.kr/detail/S000001834833)
- [이것이 취업을 위한 컴퓨터 과학이다 with CS 기술 면접](https://product.kyobobook.co.kr/detail/S000214014967)
