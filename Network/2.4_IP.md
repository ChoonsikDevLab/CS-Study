# 2.4 IP(Internet Protocol)
- 다른 네트워크와 통신을 주고 받기 위한 네트워크 계층 기술(프로토콜)
- IPv4와 IPv6 두 가지 기술을 사용

**주요 기능**
- 주소 지정 (addressing) : 네트워크 통신 과정에서 출발지와 목적지를 특정하기 위함
- 단편화와 재조립 (Fragmentation and Reassembly) : 패킷을 일정 단위(MTU)로 쪼개어 보내고 받아서 재조립
- 라우팅 (Packet Routing) : 출발지에서 목적지까지 최적의 경로를 선택
- 패킷 캡슐화(Gateway Encapsulation) : 

**특성**
- 비신뢰성 : Best Effort(최선형...?) -> 패킷의 전달을 보장하지 않으며, 손실, 순서 뒤바뀜, 중복 전송 등이 발생 할 수 있음
- 비연결성 : 데이터 전송 전 연결 성립 과정을 거치지 않음 -> 상위 계층인 TCP로 보완 가능

## IPv4
IP 패킷 헤더에는 송/수신지를 식별할 수 있는 IP 주소가 명시되어 있다.

- 총 4byte(32bit)의 크기로 구성
- 8비트 단위로 점`.` 으로 구분
- 점으로 구분된 하나의 10진수를 **옥텟(Octet)** 이라고 부른다.
- 이론적으로 할당 가능한 개수는 2^32 (약 43억개) 
	- 이후 IP 주소 고갈 문제로 IPv6 등장
- 예 : 192.168.0.1


### 구조
- 0~255 범위의 10진수 4개(32비트) 
- 네트워크 주소와 호스트 주소로 구성
	- 네트워크 주소 : 네트워크 ID, 네트워크 식별자 등으로 불림
	- 호스트 주소 : 네트워크에 속한 호스트를 특정하기 위해 사용 
		- 호스트 ID, 호스트 식별자(host identifier) 등으로 불림

### 클래스풀 주소 체계
네트워크 크기에 따라 유형별로 IP 주소를 분류하는 기준
A, B, C, E, D 5개의 종류가 있다.

실질적으로 A, B, C를 사용하며, D, E 클래스는 특수한 목적을 위해 예약된 클래스
- A 클래스 : 네트워크 주소 비트는 0으로 시작 1옥텟으로 구성, 호스트는 3옥텟으로 구성 (8bit 크기 고정)
- B 클래스 : 네트워크 주소 비트는 10으로 시작 2옥텟으로 구성, 호스트는 2옥텟으로 구성 (16bit 크기 고정)
- C 클래스 : 네트워크 주소 비트는 110으로 시작 3옥텟으로 구성, 호스트는 1옥텟으로 구성 (24bit 크기 고정)


### 네트워크 주소와 브로드캐스트 주소
- 네트워크 주소
	- 호스트 주소가 전부 0인 주소
	- 해당 네트워크 자체를 지칭하는 주소로 사용
- 브로드캐스트 주소
	- 호스트 주소가 전부 1인 주소
	- 브로드캐스트를 위한 주소로 사용

### 예약 주소
특수 목적으로 예약된 주소로 일부 호스트 주소 공간은 사용 불가

| 예약 주소          | IP 범위                       | 사용 목적                                                |
| -------------- | --------------------------- | ---------------------------------------------------- |
| 0.0.0.0/8      | 0.0.0.0-0.255.255.255       | 이 네트워크의 이 호스트                                        |
| 10.0.0.08      | 10.0.0.0 10.255.255.255     | **사설 네트워크**                                          |
| 127.0.0.08     | 127.0.0.0 127.255.255.255   | **루프백(loopback) 주소**                                 |
| 169.254.0.0/16 | 169.254.0.0 169.254.255.255 | 링크 로컬(link local) 주소<br>(호스트가 연결된 링크로 통신 범위가 제한된 주소) |
| 172.16.0.0/12  | 172.16.0.0 172.31.255.255   | **사설 네트워크**                                          |
| 192.0.2.0/24   | 192.0.2.0 192.0.2.255       | 테스트용                                                 |
| 192.168.0.0/16 | 192.168.0.0 192.168.255.255 | **사설 네트워크**                                          |
| 198.18.0.0/15  | 198.18.0.0 198.19.255.255   | 테스트용                                                 |
| 224.0.0.0/4    | 224.0.0.0- 239.255.255.255  | 멀티캐스트(D 클래스)                                         |
| 240.0.0.0/4    | 240.0.0.0-255.255.255.254   | 미래 사용 용도로 예약(E 클래스)                                  |
#### 루프백 주소(loopback address)
- 자기 자신을 가리키는 주소
- `127.0.0.1` 로컬 호스트(localhost) 라고도 불림
- 루프백 주소로 전송된 패킷은 자기 자신에게 되돌아옴
	- 자기 자신을 다른 호스트 처럼 간주하여 패킷을 전송 가능

#### 이 네트워크의 이 호스트(This host on this network)
> 이 네트워크의 이 호스트(This host on this network)를 지칭하도록 예약되었다.
> - 인터넷 표준 공식 문서(RFC 6890)

- 0.0.0.0 ~ 0.255.255.255 (0.0.0.0/8) 대역 네트워크
- 이 네트워크의 이 호스트(This host on this network) 또는 현재 네트워크 (Current network)라고 불림
- 호스트가 IP 주소를 할당 받기 전에 임시로 할당되는 IP 주소
	- 예 : DHCP Discover 메시지를 전송하는 시점의 클라이언트 IP 주소
- 특별히 지징할 IP 주소가 없을 때 사용되는 IP 주소
- 일반적인 네트워크 통신에 사용되지 않고, 소프트웨어 관련 특수 목적으로 사용

### 클래스리스 주소 체계 (classless addressing)
클래스를 이용하지 않고 IP 주소 내 네트워크 주소화 호스트 주소를 구분하는 방식

- 클래스풀 주소 체계보다 더 정교하고 유동적으로 영역을 나누기 위해 등장
	- (클래스풀 주소 단점 : IP 주소 낭비 우려가 있음)
- 서브넷팅을 이용 (반대는 슈퍼넷팅 : 쪼개진 그룹을 묶음)

### 서브넷팅(subnetting)
서브넷 마스크를 이용해 원하는 크기로 클래스를 잘게 쪼개어 사용하는 방식

- 서브넷 마스크(subnet mask) : IP 주소상에서 네트워크 주소를 1로 표기하고 호스트 주소를 0으로 표기한 비트열
- 서브 네트워크(subnetwork, subnet) : IP 주소에서 네트워크 주소로 구분할 수 있는 네트워크의 부분집합
	- 서브넷 마스크는 서브넷을 구분(마스크, maks)하는 비트열

**A, B, C 클래스별 기본 서브넷 마스크**
- A 클래스: 255.0.0.0 (11111111.00000000.00000000.00000000 )
- B 클래스: 255.255.0.0 (11111111.11111111.00000000.00000000 )
- C 클래스: 255.255.255.0 (11111111.11111111.11111111.00000000 )

**서브넷 마스크와 IP**
- 서브넷 마스크와 IP 주소 간 AND 연산을 수행하면 IP 주소 내 네트워크 주소를 알 수 있다.
- 예 : 192.168.200.102 주소와 255.255.255.0 서브넷 마스크일 때 네트워크 주소

### CIDR(Classless Inter-Domain Routing notation) 표기
서브넷 마스크 표기법중 하나
**IP 주소/서브넷 마스크상의 1의 계수** 형식으로 표기
방화벽, VPN 등 네트워크 장비와 AWS 설정, nginx 등에서 많이 사용


## IPv6
- IPv4 고갈 문제로 등장
- 16byte(128bit)로 주소를 표현하여 총 2^128 개
- 16진수로 표시하며 콜론(`:`)으로 8개 그룹으로 구분한다.
- 예 : 2001:0230:abcd:ffff:0000:0000:ffff:1111

## 공인 IP 주소와 사설 IP 주소
### 공인 IP 주소(public ip address)
- 전 세계에서 고유한 IP 주소
- 네트워크 간 통신에서 사용되는 IP 주소
- ISP나 공인 IP 주소 할당 기관을 통해 할당

### 사설 IP 주소(private ip address)
- 사설 네트워크에서 사용하기 위한 IP 주소
	- 외부 네트워크에 공개되지 않은 네트워크(외부와의 통신은 NAT를 이용)
- 라우터(공유기)를 통해 할당

**사설 IP 주소로 사용하기 위해 예약된 대역**

| CIDR           | 범위                           |
| -------------- | ----------------------------- |
| 10.0.0.0/8     | 10.0.0.0 ~ 10.255.255.255     |
| 172.16.0.0/12  | 172.16.0.0 ~ 172.31.255.255   |
| 192.168.0.0/16 | 192.168.0.0 ~ 192.168.255.255 |

** 사설 IP 주소는 접속한 네트워크에서만 유효한 주소이기에 다른 네트워크의 사설 IP 주소와 중복될 수 있다.

### NAT(Network Address Translation)
- 공인 IP ↔ 사설 IP간 변환을 위해 사용하는 기술
- 패킷이 라우팅 장치를 통해 전송되는 동안 패킷의 IP 정보를 수정하여 IP 주소를 다른 주소로 매핑
- 네트워크 내부에 있는 사설 IP 주소들은 공인 IP 주소로 1:1 대응되어 변환

**장점**
- IP 주소 부족 문제 완화
- 보안 측면에서도 내부 네트워크를 보호

**NAPT(Network Address Port Translation)**
- 포트 기반의 NAT (NAT의 확장된 형태)
- 변환활 IP 주소 쌍과 같이 포트 번호도 함께 기록하여 변환
- 여러 내부 사설 IP를 하나의 공인 IP로 매핑 가능


## IP 주소 할당
IP 주소를 할당하기 위한 방법으로 정적 할당과 동적 할당이 존재  


기본적으로 외부와 네트워크 통신에 필요한 항목
- IP 주소
- 서브넷 마스크
- 기본 게이트웨이
- DNS 서버 주소

### 정적 할당
직접 IP 주소를 설정(부여)하는 방식  
이렇게 설정한 IP 주소를 **정적 IP 주소(static IP address)**  
주로 IP 주소가 변경되어야 하지 않는 기업, 서버 운영 등에서 사용  

### 동적 할당
프로토콜을 통해 IP 주소를 자동으로 부여 받는 방식  
이렇게 할당 받은 주소를 **동적 IP 주소(dynamic IP address)**  
동적 할당에 사용되는 대표적인 프로토콜은 DHCP  

#### DHCP(Dynamic Host Configuration Protocol)
클라이언트는 DHCP 서버와 메시지를 주고 받으며 IP를 할당 받음  
DHCP 서버는 호스트에 할당 가능한 주소 목록을 관리하며, 할당 요청을 받았을 때 IP 주소를 할당  

동적 IP 주소에는 다음과 같은 특징이 존재  
- 사용 가능한 기간(임대 기간)이 정해져 있음
- 할당받을 때 마다 IP 주소가 달라질 수 있음

**IP 주소 임대**
- DHCP로 할당 받은 주소는 사용할 기간이 정해져 있으며, 사용되지 않을 경우 회수됨
- 사용 기간이 끝난 IP 주소는 DHCP서버로 반납
- 새롭게 주소를 할당 받는 경우 다른 주소를 할당 받을 수 있음
- 임대 기간이 끝나기 전 **임대 갱신(lease renewal)** 을 통해 연장할 수 있음
	- 임대 갱신 요청은 자동으로 두 차례 운영체제에서 수행 (50%, 87.5%)
	- 두 번 모두 실패하면 DHCP 서버로 반납됨

### 게이트웨이(Gateway)
서로 다른 네트워크를 연결하는 HW/SW 수단  
- **기본 게이트웨이(default gateway)** : 호스트가 속한 네트워크의 외부로 나가기 위한 첫 기본 경로


## 라우팅
IP 주소를 찾아가는 과정

**주소 체계**
- MAC 주소 :물리적 주소, 배송 과정의 수신인과 발신인에 해당
- IP 주소 : 논리적 주소, 수신 주소과 발신 주소를 나타냄
패킷 송수신 과정에서 MAC 주소보다 IP 주소가 우선적으로 활용

### 라우터
서로 다른 네트워크간 패킷을 전달하는 네트워크 계층 장비  
- 전달받은 패킷을 목적지까지 전달
- IP 패킷의 최적 경로를 결정하여 전송 (라우팅, routing)

**라우팅 테이블**
목적지 네트워크와 도착하기 위한 정보를 담고있는 데이터베이스  
목적지 네트워크 주소, 다음 홉(next hop) 주소, 인터페이스 정보

**라우팅 프로토콜**
- 정적 라우팅 : 관리자가 수동으로 라우팅 테이블 설정
- 동적 라우팅 : 라우터가 자동으로 최적 경로를 계산하고 업데이트
	- RIP, OSPF, BGP 등

## 관련 기술
### MTU(Maximum Transmission Uit)
최대 전송 단위  

- 전송하고자 하는 IP 패킷의 크기가 MTU 단위보다 클 경우 MTU 이하의 여러 패킷으로 쪼개어 전송하고, 수신지에서 재조합
- 일반적인 MTU 크기는 1500바이트
	- 이 이상으로 전송하는 방식은 점보 프레임
- IP 단편화와 관련

### ICMP(Internet Control Message Protocol)
IP 프로토콜은 신뢰할 수 없는 비연결형 프로토콜 → 이를 보완하기 위해 ICMP를 사용  
ICMP는 네트워크 계층 프로토콜  

**주요 기능**
- 오류 보고
- 네트워크 상태 진단
- 네트워크 정보 제공

**ICMP 메시지 유형**
- 전송 과정에서 발생한 오류 보고
- 네트워크에 대한 진단 정보

**ICMP 이용 툴**
- ping : 네트워크 연결 상태 테스트
- traceroute/tracert : 목적지 까지 경로 추적

```
ping one.one.one.one
PING one.one.one.one (1.1.1.1): 56 data bytes
64 bytes from 1.1.1.1: icmp_seq=0 ttl=54 time=12.886 ms
```

### TTL(Time to Live)
패킷의 수명
IP 헤더에 TTL 필드가 존재

패킷은 외부 호스트끼리 통신할 때 여러 라우터를 거치게 되는데,   
이 때 패킷이 하나의 라우터를 거칠 때 마다 TTL이 1씩 감소  
TTL은 무의미한 패킷이 네트워크에 남아있는 것을 방지하기 위해 존재  

TTL 필드가 0이 되면 해당 패킷은 폐기되고, 송신 호스트에게 시간 초과(Time Excceded) ICMP 메시지 전송  

패킷이 호스트 또는 라우터 한 번 전달되는 것을 **홉(hop)** 이라고 하며, 이러한 통신 과정을 **홉바이홉 통신**  
TTL 필드의 값은 홉마다 1씩 감소  

### ARP(Address Resolution Protocol)
가상 주소인 IP 주소를 실제 주소인 MAC 주소로 변환  
반대로 RARP를 통해 MAC 주소를 IP 주소로 변환  

패킷 송수신 과정에서 상대 호스트의 IP 주소는 알고 MAC 주소는 모르는 상황에 활용 가능  

ARP Request (브로드캐스트)를 보내어 ARP Response (유니캐스트) 를 받음  

ARP를 활용하는 호스트는 ARP 테이블(ARP Table)을 이용해 정보를 유지 (IP, MAC)  
일정 시간이 지나면 삭제, 임의로 삭제할 수 있음  

### cf) 네트워크 통신 방식 

| 타입     | 대상        | 범위            | IPv4 | IPv6 | 주요 용도                                |
| ------ | --------- | ------------- | ---- | ---- | ------------------------------------ |
| 유니캐스트  | 1:1       | 전체 네트워크       | O    | O    | 일반적인 인터넷 통신(HTTP)                    |
| 브로드캐스트 | 1:모두      | 서브넷 (로컬 네트워크) | O    | X    | 네트워크 장치 탐색(ARP)                      |
| 멀티캐스트  | 1:그룹      | 정의된 구간        | O    | O    | 스트리밍(IPTV), 화상 회의                    |
| 애니캐스트  | 1:1 (최근접) | 전체 네트워크       | △    | O    | IPv6에서 주로 사용, 가까운 DNS 서버 탐색, CDN 서비스 |

### 도메인 네임과 DNS
IP 주소로 특정 호스트를 특정하기 어렵기 때문에 **도메인 네임(domain name)** 을 사용  
도메인 이름을 사용했을 때 호스트의 IP 주소를 변환해 주는 시스템을 **DNS(domain name system)**

- 네임 서버(name server) : 도메인 네임과 대응하는 IP 주소를 관리하는 서버
- DNS 서버(DNS server) : 도메인 네임을 관리하는 네임 서버
특정 도메인 네임을 가진 호스트의 IP 주소를 DNS 서버에 질의하는 과정을 리졸빙(reslving)라고 표현  

도메인 네임과 이것을 관리하는 네임 서버는 계층적 구조를 띔  
- 도메인 : 점(.)을 기준으로 계층적 분류
	- 루트 도메인(root domain)
	- 최상위 도메인(TLD, Top-Level Domain) (예 : com, net, org, kr, jp)
	- 2단계 도메인(세컨드 레벨 도메인, second-level domain) 
	- 3단계 도메인 (보통 3~5단계로 구성)
- 전체 주소 도메인 네임(FQDN, Full-Qualified Domain Name) : 완전한 도메인 이름
- 서브 도메인(subdmain) : 다른 도메인이 포함된 도메인 (mail.example.com, auth.example.com 등)
- 로컬 네임 서버(Local Name Server) : 호스트가 가장 먼저 질의하는 네임 서버 (보통 ISP에서 할당)
- 공개 DNS 서버(public DNS Server) : 공개적으로 운영하는 서버 (Google 8.8.8.8, Cloudflare 1.1.1.1)

로컬 네임 서버가 FQDN에 대응하는 주소를 알고 있다면 즉시 반환  
그러나 로컬 네임 서버가 모른다면 알아낼 때 까지 상위 서버에 질의하게 됨  
루트 네임 서버 → TLD 네임 서버 → 하위 레벨 관장 서버 ... 이어서 질의  
최종적으로 클라이언트가 찾는 IP 주소를 서버가 반환하면 클라이언트에게 전달  

- 루트 네임 서버(root name server) : 도메인 네임의 루트 도메인을 관장하는 서버
- TLD 네임 서버 (TLD name server) : 최상위 도메인을 관장하는 서버


- DNS 캐시(DNS Cache) : 기존에 응답받은 DNS 질의 결과를 임시로 저장
	- 질의 과정이 계속 반복되면 네트워크 내 트래픽과 리졸빙 시간을 줄이는 데 활용
	- 각 DNS 레코드에는 TTL이 설정되어, 해당 기간 동안만 저장

#### DNS 리졸빙 과정
1. DNS 캐시를 확인
2. 로컬 네임 서버 (주로 ISP의 DNS 서버)에 질의
3. 필요 시 루트 서버, TLD 서버 ... 순으로 질의가 전달되어 반환

#### DNS 레코드(DNS resource record)
도메인 소유자가 해당 도메인 네임에 대응하는 IP 주소 등의 정보를 설정하는 데 사용되는 정보

| 레코드 유형 | 설명                                 |
| ------ | ---------------------------------- |
| A      | 특정 호스트에 대한 도메인 네임과 IPv4 주소와의 대응 관계 |
| AAAA   | 특정 호스트에 대한 도메인 네임과 Ipv6 주소와의 대응 관계 |
| CNAME  | 호스트 네임에 대한 별칭 지정                   |
| NS     | 특정 호스트의 IP 주소를 찾을 수 있는 네임 서버       |
| MX     | 해당 도메인과 연동되어 있는 메일 서버              |

# 예상 질문

<details>
<summary>네트워크 통신 방식 4가지에 대해 설명해주세요.</summary>

```
네트워크 통신 방식에는 유니캐스트, 브로드캐스트, 멀티캐스트, 애니캐스트 4가지가 있습니다.
유니캐스트는 1:1 통신 방식으로 대부분의 통신은 유니캐스트 방식을 사용합니다.
브로드캐스트는 1:로컬 네트워크 모든 통신 방식으로 네트워크 장치를 탐색할 때 사용됩니다.
멀티캐스트는 1:특정 그룹 간 통신 방식으로 IPTV와 같은 스트리밍 방식에서 사용합니다.
애니캐스트는 1:1 통신으로 특정되지 않고 동일 그룹 중 가장 가까운 호스트와 통신하고, IPv6에서 주로 사용됩니다.
```

</details>


<details>
<summary>NAT에 대해 설명해주세요.</summary>

```
NAT는 IP주소를 변환하는 기술로, 네트워크 내부에서 사용하는 사설 IP 주소와 외부에서 사용하는 공인 IP 주소를 변환하는 데 사용됩니다.
```

</details>


<details>
<summary>Public IP와 Private IP 차이</summary>

```
public ip(공인 ip)는 인터넷 공급자(ISP)가 제공하는 IP 주소로, 외부에 공개되어 있는 주소입니다.
private ip(사설 ip)는 일반 가정이나 회사 사내 등에서 할당된 주소로 IPv4의 주소 부족으로 서브넷팅된 IP 이기에 라우터(공유기)에 의해 내부 네트워크에 연결된 장치에 할당됩니다.
사설 IP 대역은 외부에서 사용하지 않는 예약 주소이기 때문에 직접 연결할 수 없고, 내부에서는 NAT 기술을 통해 외부와 통신하게 됩니다.
```

</details>


<details>
<summary>ARP가 무엇이고 사용과정은 어떻게 되나요?</summary>

```
ARP 프로토콜은 IP 주소를 통해 MAC 주소를 얻을 때 사용됩니다.
IP 주소를 통해 패킷이 목적지 네트워크에 도달할 때 해당 목적지 네트워크내의 실제 장치로 전달하기 위해선 MAC 주소가 필요합니다.
이 때 패킷은 IP주소는 가지고 있으나 MAC 주소를 모르기 때문에 이 때 ARP를 사용하게 됩니다.

동작원리는 다음과 같습니다.
주소를 찾으려는 장치가 IP 주소가 담긴 ARP Request 브로드캐스트를 보냅니다.
ARP 요청을 받은 장치 중 해당 IP를 가진 장치는 ARP Response 유니캐스트를 통해 MAC 주소를 반환합니다.
이 과정을 통해 IP 주소에 맞는 MAC 주소를 획득할 수 있습니다.
```

</details>


# 참고자료
- 면접을 위한 CS 전공지식 노트(길벗, 주홍철)
- 이것이 취업을 위한 컴퓨터 과학이다 with CS 기술 면접 (한빛미디어, 강민철)
- https://justdataplease.com/understanding-ip-addresses-for-data-analysis-using-bigquery/
- https://ipshu.com/
